name: Release NullGravity

on:
  push:
    branches:
      - master

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            binary_name: 'nullgravity-core-x86_64-pc-windows-msvc.exe'
            pyinstaller_name: 'backend.exe'
          - platform: 'ubuntu-22.04'
            binary_name: 'nullgravity-core-x86_64-unknown-linux-gnu'
            pyinstaller_name: 'backend'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Frontend Dependencies
        run: npm install

      # =======================================================
      # 本地构建后端 Sidecar 二进制
      # =======================================================
      - name: Build Backend with PyInstaller (Windows)
        if: matrix.platform == 'windows-latest'
        shell: bash
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

          pyinstaller \
            --onefile \
            --name backend \
            --noconsole \
            --icon ../src-tauri/icons/icon.ico \
            --hidden-import aiosqlite \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.http.h11_impl \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.protocols.websockets.websockets_impl \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.main \
            --hidden-import anyio \
            --hidden-import anyio._backends._asyncio \
            --hidden-import sqlalchemy.dialects.sqlite \
            --hidden-import sqlalchemy.dialects.sqlite.aiosqlite \
            --hidden-import pydantic.v1 \
            --collect-all curl_cffi \
            --collect-all uvicorn \
            main.py

      - name: Build Backend with PyInstaller (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        shell: bash
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

          pyinstaller \
            --onefile \
            --name backend \
            --hidden-import aiosqlite \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.http.h11_impl \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.protocols.websockets.websockets_impl \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.main \
            --hidden-import anyio \
            --hidden-import anyio._backends._asyncio \
            --hidden-import sqlalchemy.dialects.sqlite \
            --hidden-import sqlalchemy.dialects.sqlite.aiosqlite \
            --hidden-import pydantic.v1 \
            --collect-all curl_cffi \
            --collect-all uvicorn \
            main.py

      - name: Place Binary into Tauri Binaries
        shell: bash
        run: |
          mkdir -p src-tauri/binaries
          cp backend/dist/${{ matrix.pyinstaller_name }} src-tauri/binaries/${{ matrix.binary_name }}

          FILE_SIZE=$(stat -c%s "src-tauri/binaries/${{ matrix.binary_name }}" 2>/dev/null || stat -f%z "src-tauri/binaries/${{ matrix.binary_name }}")
          echo "Binary size: $FILE_SIZE bytes"
          if [ "$FILE_SIZE" -lt 5000000 ]; then
            echo "Error: Binary is too small ($FILE_SIZE bytes), build likely failed."
            exit 1
          fi

      - name: Bump Version
        shell: bash
        run: |
          sed -i -E 's/"version": "[0-9]+\.[0-9]+\.[0-9]+"/"version": "0.1.${{ github.run_number }}"/g' src-tauri/tauri.conf.json

      - name: Build and Release Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: '.'
          tauriScript: npx tauri
          tagName: v0.1.${{ github.run_number }}
          releaseName: 'NullGravity Build 0.1.${{ github.run_number }}'
          releaseBody: '最新的全自动打包版本。'
          releaseDraft: false
          prerelease: true
          args: ${{ matrix.args }}
